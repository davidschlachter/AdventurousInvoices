<html>

<head>
  <title>Adventurous Invoices - Client</title>
  <link rel="stylesheet" href="stylesheets/style.css">
  <script src="javascripts/jquery-3.4.1.min.js"></script>
  <script src="javascripts/nodep-date-input-polyfill.dist.js"></script>
  <script src="javascripts/moment-2.24.0.min.js"></script>
</head>

<body>
  <main>
    <h1><a href="index.html">Adventurous Invoices</a></h1>
    <h2 id=clientNameH2></h2>
    <p id=emails>Emails: </p>
  
    <table id=clientsTable></table>

    <h3>Events between:</h3>
    <table id=dateselectorbox>
      <tr>
        <td>
          <input id=startdate type="date"><br>
          <input id=enddate type="date">
        </td>
        <td id=calendarBox></td>
      </tr>
    </table>

    <p id=invoiceTable></p>
    
    <div style="text-align:center;">
      <button id=newinvoice type="button">Send to Drafts folder</button>
    </div>
    
    <h3>Expenses</h3>
    
    <h4>New expense</h4>
    
    <form id=newexpenseform enctype="multipart/form-data">
      Date:
      <input id=expdate name=dateRaw type="date"><br>
      Description:
      <input id=expdescr name=description type=text><br>
      Amount:
      <input id=expamt name=amount type=number min=0 step=0.01><br>
      Receipt:
      <input id=expfile name=receipt type=file accept="image/png,image/jpeg,.jpg,.jpeg">
      <div style="text-align:center;">
        <button id=newexpensesubmit type="button">Add expense</button>
      </div>
    </form>
    
    <h2>Previous invoices</h2>
  
  </main>
</body>

<script>
  const urlParams = new URLSearchParams(window.location.search)
  const clientID = urlParams.get('clientID')
  let client = {}
  let feeRate = 16.0
  
  getExpenses()
  
  $( document ).ready(function() {
    
    $.get("getClient?clientID="+clientID, function(res) {
      console.log(res)
      client = res
      $("#clientNameH2").text(client[0].name)
      let emailAddresses = ""
      for (let i=0;i<client.length;i++) {
        emailAddresses += client[i].address
        if ((i+1) !== client.length) emailAddresses += ", "
      }
      $("#emails").append(emailAddresses)
    })
    
    today = new Date()
    $("#enddate").val(today.toISOString().split('T')[0])
    let twoWeeksAgo = new Date(new Date().setDate(today.getDate() - 14))
    $("#startdate").val(twoWeeksAgo.toISOString().split('T')[0])
    
    $("#startdate").change(function() {
      getEvents($("#startdate").val(), $("#enddate").val())
    })
    $("#enddate").change(function() {
      getEvents($("#startdate").val(), $("#enddate").val())
    })
    
    getEvents($("#startdate").val(), $("#enddate").val())
    
    $("#newinvoice").click(function() {
      $("#newinvoice").attr("disabled", true)
      newInvoice()
    })
    
    $('#newexpensesubmit').on('click', function () {
      $("#newexpensesubmit").attr("disabled", true)
      newExpense()
    })
    
    $("#calendarBox").html( makeCalendar() )
    
  })
  
  function getEvents(startDate, endDate) {
    console.log(startDate, endDate)
    let offset = -(new Date().getTimezoneOffset() / 60)
    $.get("getEvents?startDate="+startDate+"&endDate="+endDate+"&offset="+offset, function(events) {
      showEvents(events)
    })
  }
  
  function newInvoice() {
    data = {}
    data.table = $("#invoiceTable").html()
    data.startDate = $("#startdate").val()
    data.endDate = $("#enddate").val()
    data.emails = client
    data.offset = -(new Date().getTimezoneOffset() / 60)
    $.ajax({
      type: "POST",
      url: "newInvoice",
      data: data,
      success: function(data) {
        console.log(data)
      }
    })
  }
  
  function newExpense() {
    // https://stackoverflow.com/a/8758614/3380815
    let formData = new FormData($('#newexpenseform')[0])
    formData.append('client', clientID)
    formData.append('date', $("#expdate").val() )
    $.ajax({
      url: 'newexpense',
      type: 'POST',
      data: formData,
      // Tell jQuery not to process data or worry about content-type
      cache: false,
      contentType: false,
      processData: false,
      success: function(data) {
        console.log(data)
      }
    }).done(function(){
      $("#newexpensesubmit").attr("disabled", false)
      $('#newexpenseform')[0].reset()
      getExpenses()
    }).fail(function(){
      console.log("An error occurred, the data couldn't be sent!")
    })
  }
  
  function getExpenses() {
    $.get("getexpenses?clientID="+clientID, function(res) {
      expenses = res
      console.log(res)
      getEvents($("#startdate").val(), $("#enddate").val())
    })
  }
  
  function showEvents(events) {
    let queryStartDate = moment($("#startdate").val())
    let queryEndDate = moment($("#enddate").val())
    let eventsText  = '<span className="summaryHead">Date         Hours           Time (h)  Amount</span><br/>'
    eventsText += '<span>--------------------------------------------------<br/></span>'
    let amountsTotal = 0
    let hoursTotal = 0
    for (let i=0; i<events.length; i++) {
      if (typeof(events[i].attendees) !== 'object') continue
      if (events[i].attendees.length === 0) continue
      isInvited = false
      for (let j=0; j<events[i].attendees.length; j++) {
        for (let k=0; k < client.length; k++) {
          if (events[i].attendees[j].email === client[k].address) isInvited = true
        }
      }
      if (isInvited === true) {
        console.log(events[i])
        // Quoted roughly from AdventureInvoicing/Invoices/views/CalendarFetcher.js
        if (typeof events[i].start.dateTime === 'string') {
          start = new moment(events[i].start.dateTime)
          endTime = new moment(events[i].end.dateTime).format('HH:mm')
          startHour = start.format('HH:mm')
          amountNumber = ((moment(events[i].end.dateTime).valueOf() - moment(events[i].start.dateTime).valueOf()) / (1000*3600))*feeRate
          time = (amountNumber / feeRate).toFixed(2)
          time = time.padStart(6, ' ').replace('.00', '   ')
        } else if (typeof events[i].start.date === 'string') {
          start = new moment(events[i].start.date)
          amountNumber = 24*feeRate
          time = ' 24.00'
          endTime = '00:00'
          startHour = '00:00'
          startHour = '00:00'
        } else {
          console.log("Error: couldn't parse date")
          continue
        }
        if (startHour.charAt(0) === '0') startHour = ' ' + startHour.substr(1, startHour.length-1)
        if (endTime.charAt(0) === '0') endTime = ' ' + endTime.substr(1, endTime.length-1)
        rate = "$" + feeRate.toFixed(2)
        amount = ""
        amount = "$ " + amountNumber.toFixed(2).padStart(6, ' ').replace('.00', '   ')
        amount = amount.replace('.00', '   ')
        amountsTotal = amountsTotal + amountNumber
        hoursTotal = hoursTotal + (amountNumber / feeRate)
        eventsText += '<span id=event'+events[i].eventId+'>'+start.format('ddd MMM DD')+'   '+startHour+' â€“ '+endTime+'   '+time+'       '+amount+'<br/></span>'
      }
    }
    eventsText += "<span>--------------------------------------------------<br/></span>"
    // Process expenses
    for (let i=0; i<expenses.length; i++) {
      expensedate = new moment(expenses[i].date)
      if (expensedate.isSameOrAfter(queryStartDate) && expensedate.isSameOrBefore(queryEndDate)) {
        expensedescription = expenses[i].description.padEnd(24, ' ')
        expenseamount = "$ " + expenses[i].amount.toFixed(2).padStart(6, ' ').replace('.00', '   ')
        
        amountsTotal = amountsTotal + expenses[i].amount
        eventsText += '<span id=expense'+expenses[i].id+'>'+expensedate.format('ddd MMM DD')+'   '+expensedescription+'     '+expenseamount+'<br/></span>'
      }
      if ((i+1) === expenses.length) eventsText += "<span>--------------------------------------------------<br/></span>"
    }
    // Totals line
    eventsText += '<span>                    Total:   '+hoursTotal.toFixed(2).padStart(6, ' ').replace('.00', '   ')+'       $'+amountsTotal.toFixed(2).padStart(7, ' ')+'</span><br/>'
    $("#invoiceTable").html(eventsText)
  }
  
  function makeCalendar() {
    let a = moment()
    let sunday = a.clone().weekday(0)
    let oneweekago = sunday.clone().subtract(1, 'week')
    let twoweekago = sunday.clone().subtract(2, 'week')
    let calendarString = ""
    calendarString += "<i>Su Mo Tu We Th Fr Sa</i><br>"
    calendarString += 
      twoweekago.format("DD") + " " +
      twoweekago.clone().add(1, 'day').format("DD") + " " +
      twoweekago.clone().add(2, 'day').format("DD") + " " +
      twoweekago.clone().add(3, 'day').format("DD") + " " +
      twoweekago.clone().add(4, 'day').format("DD") + " " +
      twoweekago.clone().add(5, 'day').format("DD") + " " +
      twoweekago.clone().add(6, 'day').format("DD") + "<br>"
    calendarString += 
      oneweekago.format("DD") + " " +
      oneweekago.clone().add(1, 'day').format("DD") + " " +
      oneweekago.clone().add(2, 'day').format("DD") + " " +
      oneweekago.clone().add(3, 'day').format("DD") + " " +
      oneweekago.clone().add(4, 'day').format("DD") + " " +
      oneweekago.clone().add(5, 'day').format("DD") + " " +
      oneweekago.clone().add(6, 'day').format("DD") + "<br>"
    calendarString +=
      sunday.format("DD") + " " +
      sunday.clone().add(1, 'day').format("DD") + " " +
      sunday.clone().add(2, 'day').format("DD") + " " +
      sunday.clone().add(3, 'day').format("DD") + " " +
      sunday.clone().add(4, 'day').format("DD") + " " +
      sunday.clone().add(5, 'day').format("DD") + " " +
      sunday.clone().add(6, 'day').format("DD")
    calendarString = calendarString.replace(a.format("DD"), "<b>"+a.format("DD")+"</b>")
    return calendarString
  }
  
</script>

</html>
